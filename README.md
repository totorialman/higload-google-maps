# Google Maps 

## 1. Тема и целевая аудитория
**Google Maps** - сервис Google для просмотра карт, спутниковых снимков, панорам улиц и построения маршрутов в реальном времени.

### Функционал MVP
- Просмотр карты  
- Построение маршрутов  
- Поиск мест и организаций  
- Просмотр информации о местах  
- Загрузка офлайн-карт  

### Целевая аудитория
MAU: **2 млрд пользователей**[^1]

| Страна   | Доля[^2] | Пользователей в месяц |
|----------|------|------------------------|
| США      | 11,32 % | 226 млн |
| Турция   | 8,77 %  | 175 млн |
| Япония   | 8,24 %  | 165 млн |
| Индия    | 6,64 %  | 133 млн |
| Бразилия | 6,14 %  | 123 млн |
| Остальные| 58,89 % | 1178 млн |

---

## 2. Расчет нагрузки
### Продуктовые метрики

| Метрика | Значение |
|---------|----------|
| MAU[^1] | 2 млрд |  
| DAU[^3] (stickiness 30%) | 600 млн |  
| Среднее число запусков приложения в месяц[^3] | 50 |  
| Среднее число сессий в день (расчёт) | 1,67 | расчёт 
| Количество мест в базе[^1] | 250 млн |  

---

### Среднее количество действий одного пользователя в день

| Действие                        | Повторений в день | Обоснование |
|---------------------------------|-------------------|-------------|
| Отображение карты               | 20,0               | В среднем 50 запусков в месяц ≈ 1,67 в день |
| Отображение информации о местах | 3,3               | В среднем 2 запроса на сессию при 1,67 сессии в день |
| Поиск мест и организаций        | 2,4               | 71% сессий включают поиск[^4], по 2 запроса: 1,67 × 0,71 × 2 ≈ 2,4 |
| Построение маршрутов            | 1,3               | 75% сессий включают построение маршрута[^4]: 1,67 × 0,75 ≈ 1,3 |
| Следование по маршруту          | 8,0               | В среднем 1 маршрут в день. Средняя поездка 30 минут, обновление позиции каждые 15 секунд - 120 обновлений. Используется батчинг и агрегация информации о пробках и ETA. В результате из 120 обновлений реально превращается примерно в 8 сетевых запросов |
|Загрузка тайлов во время навигации (prefetch + viewport)|16,0|Prefetch ~150 тайлов/маршрут по 12 за запрос, viewport ~3 запроса по 24 тайла - суммарно ~16 сетевых запроса/сессию|
| Загрузка оффлайн-карт           | 0,02              | Загрузка/обновление ≈ 1 раз в 2 месяца |

1. Сырой объём точек: при 30-минутной поездке и интервале 15 с получается 120 точек. 
2. Обычно делают агрегацию/батчинг: они группируют несколько GPS-точек и метаданных в один сетевой вызов. Практические реализации группируют 10–20 точек в один пакет
3. Допустим, клиент аггрегирует в среднем по 15 точек в пакет → 120 / 15 = 8 пакетных отправок
---

### Технические метрики

В базе ~250 млн объектов[^1]. Основные поля и предполагаемый размер записи:

| Поле                     | Описание                      | Средний объем на 1 объект |
| ------------------------ | ----------------------------- | ------------------------- |
| **ID места**             | Уникальный идентификатор      | 16 байт                   |
| **Название**             | Текст (UTF-8)                 | 50 байт                   |
| **Категория**            | Тип места (кафе, отель, парк) | 16 байт                   |
| **Координаты (lat/lon)** | Два float-числа               | 16 байт                   |
| **Часы работы**          | JSON-объект                   | 200 байт                  |
| **Отзывы**               | Список текстовых данных       | ~1 КБ (по 10 отзывов)     |
| **Рейтинг**              | Число с плавающей точкой      | 8 байт                    |
| **Доп. данные**          | Телефон, сайт, соцсети        | 200 байт                  |

Согласно официальному Places API[^7], есть ещё много дополнительных полей (например, типы мест, метки, варианты парковки и тд), поэтому **округляю средний размер объекта до 3 КБ**.  

### Информация о местах: 250 млн × 3 КБ ≈ **720 ГБ**  
### Размер кэша тайлов: **1250 ГБ**
- Зумы 10–16: ≈ **5.7 млрд тайлов**
- Только 25–30% реально кэшируется (города, дороги) → **~1.71 млрд тайлов**
- Объём: 1.71e9 × 600 Б = **1026 ГБ**
- С запасом (разные форматы, метаданные) → **~1300 ГБ**

**Итоговое хранилище ≈ 2 ТБ.**

---

### RPS по типам запросов

**DAU = 600 млн.**  
**Среднее время суток = 86 400 секунд.**  
Пиковая нагрузка = 3× среднего значения.

Отображение карты: 20,0 (действий в сутки) / 86400 (секунд в сутках) * 600M DAU ≈ 13.9K

| Тип запроса                | Действий/день | Средний RPS     | Пиковый RPS (×3) |
|----------------------------|---------------|------------------|------------------|
| Отображение карты          | 20,0           | 138,9K            | **416,7K**        |
| Информация о местах        | 3,3           | 23,2K            | **69,6K**        |
| Поиск мест                 | 2,4           | 16,5K            | **49,5K**        |
| Построение маршрутов       | 1,3           | 9,0K             | **27,0K**        |
| Следование по маршруту     | 8,0           | 55,6K            | **166,7K**       |
|Загрузка тайлов во время навигации (prefetch + viewport)|16,0|111,1K|**333,3K**|
| Загрузка оффлайн-карт      | 0,02          | 139              | **417**          |
---

### Сетевой трафик

| Тип запроса                | Размер 1 запроса | Средний RPS | Пиковый RPS | Пиковый трафик |
|-----------------------------|------------------|-------------|-------------|----------------|
| Отображение карты           | 7,2 КБ (~12 тайлов за раз при 1080p при 16 уровне масштабирования) | 138,9K | 416,7K | **~23,96 Гбит/с**  |
| Информация о местах         | 3 КБ             | 23,2K | 69,6K | **~1,67 Гбит/с**   |
| Поиск мест                  | 1 КБ (10 результатов)            | 16,5K | 49,5K   | **~0,4 Гбит/с**   |
| Построение маршрутов        | 5,2 КБ (Маршрут ~10 км: ~200 точек × 16 Б = 3,2 КБ + метаданные (~2 КБ) → ≈ 5,2 КБ)          | 9,0K  | 27,0K | **~1,12 Гбит/с** |
| Следование по маршруту        | 2,5 КБ (обновление позиции, ETA)| 55,6K      | 166,7K      | **~3,3 Гбит/с** |
|Загрузка тайлов во время навигации (prefetch + viewport)|21,6 КБ (600 B / тайл  (prefetch), 14,4 KB / viewport)|111,1K|333,3K|**~57,5Гбит/с**|
| Загрузка оффлайн-карт       | 10 МБ (≈ 17 000 тайлов уровня 16, один тайл ≈ 0,12 км², общая площадь ≈ 2 048 км²)            | 139   | 417   | **~33,4 Мбит/с**  |

**Площадь одного тайла на уровне 16**  

- На уровне 16 весь земной шар делится на 2^16 * 2^16 = 65,536 * 65,536 тайлов.  
- Земная поверхность ≈ 510 млн км².  
- Площадь одного тайла:  ≈ 0,12 км² 

**Общая площадь оффлайн-карты**  

- Количество тайлов: 17 067  
- Общая площадь: 17 067 × 0,12 км² ≈ 2 048 км²
---

# 3. Глобальная балансировка нагрузки

## Обоснования расположения ДЦ (влияние на продуктовые метрики)

Распределение пользователей по странам (по данным hypestat[^10] и SimilarWeb App Intelligence[^2]) показывает, что наибольшая доля трафика приходится на США. Далее следуют Индия, Китай, Бразилия и Япония.  
Чтобы минимизировать сетевые задержки и обеспечить высокую доступность, дата-центры целесообразно размещать в ключевых точках присутствия пользователей.

**Выбранные регионы для ДЦ:**
- **США**: Нью-Йорк (Восток), Лос-Анджелес (Запад), Чикаго (Центр)  
- **Европа**: Франкфурт-на-Майне (низкие задержки для Европы и части Африки)  
- **Азия**: Мумбаи (Индия), Пекин (Китай), Токио (Япония)  
- **Южная Америка**: Сан-Паулу (Бразилия)  

Такое расположение обеспечивает покрытие всех ключевых регионов, снижает latency и повышает отказоустойчивость.

<img width="1549" height="698" alt="image" src="https://github.com/user-attachments/assets/7316186e-372e-490d-af73-6acc5f602dbd" />


---

## Распределение нагрузки по регионам

| Тип запроса                        | Нью-Йорк | Лос-Анджелес | Чикаго | Франкфурт | Мумбаи | Пекин | Сан-Паулу | Токио |
| ---------------------------------- | -------- | ------------ | ------ | --------- | ------ | ----- | --------- | ----- |
| **Отображение карты** (416.7K)     | 52.1K    | 52.1K        | 52.1K  | 62.5K     | 62.5K  | 62.5K | 62.5K     | 62.5K |
| **Информация о местах** (69.6K)    | 8.7K     | 8.7K         | 8.7K   | 10.9K     | 10.9K  | 10.9K | 10.9K     | 10.9K |
| **Поиск мест** (49.5K)             | 6.2K     | 6.2K         | 6.2K   | 7.8K      | 7.8K   | 7.8K  | 7.8K      | 7.8K  |
| **Построение маршрутов** (27.0K)   | 3.4K     | 3.4K         | 3.4K   | 3.9K      | 3.9K   | 3.9K  | 3.9K      | 3.9K  |
| **Следование по маршруту** (166.7K)| 20.8K    | 20.8K        | 20.8K  | 20.8K     | 27.8K  | 27.8K | 27.8K     | 27.8K |
| **Загрузка тайлов** (333.3K)       | 41.7K    | 41.7K        | 41.7K  | 41.7K     | 62.5K  | 62.5K | 21.4K     | 20.1K |
| **Оффлайн-карты** (417)            | 52       | 52           | 52     | 52        | 52     | 52    | 52        | 52    |

> Распределение сделано пропорционально MAU в регионах. США обслуживаются тремя узлами для равномерного снятия нагрузки.

---

## Выбор схемы глобальной балансировки

Оптимальной схемой является **Anycast-балансировка в сочетании с Geo-Based DNS**.

- **Geo-Based DNS**:
  - Используется для глобального распределения пользователей по регионам (США, Европа, Азия, Южная Америка).  
  - Позволяет направлять запросы в ближайший дата-центр на уровне DNS.  
  - Обеспечивает резерв в случае полной недоступности Anycast-кластера в регионе.  

- **Anycast-балансировка**:
  - Применяется внутри США, где расположены несколько дата-центров (Нью-Йорк, Лос-Анджелес, Чикаго).  
  - Один IP-адрес анонсируется в нескольких точках, маршрутизация BGP направляет трафик в ближайший узел.  
  - Снижает задержки за счёт выбора кратчайшего сетевого пути.  
  - Распределяет трафик между несколькими узлами и повышает устойчивость к DDoS-атакам.  
  - Позволяет быстро выводить узлы из работы при отказе (BGP withdraw) без ожидания обновления DNS-записей.  

### В итоге:

- **Основной механизм**: Geo-Based DNS для глобального распределения по регионам.  
- **Внутрирегиональный механизм**: Anycast в США для балансировки между несколькими дата-центрами.  
- **Fallback**: при отказе всего регионального Anycast-кластера DNS перенаправляет пользователей в соседний регион.  
- минимальные задержки на глобальном уровне.  
- отказоустойчивость при сбоях отдельных узлов или целых регионов.  
- масштабируемость и устойчивость к DDoS.  

## 4. Локальная балансировка нагрузки

### Балансировщик уровня L7
Выбран **NGINX**, так как он сочетает высокую производительность, гибкость конфигурации и широкую поддержку протоколов.  
Он позволяет:  
- выполнять SSL termination на краю, снижая нагрузку на backend;  
- кешировать тайлы и карты для уменьшения обращений к сервисам;  
- сжимать ответы (gzip/brotli), экономя трафик и снижая задержки.  

### Алгоритмы балансировки
Используются разные политики для оптимизации под типы трафика:  
- **Consistent Hash** - для тайлов и статических ресурсов, чтобы повысить cache-hit на бекендах.  
- **Least Connections** - для динамических запросов (поиск, маршруты), так как они неравномерны по времени выполнения.  
- **Round Robin** - как универсальный вариант при низкой нагрузке и равномерных запросах.  

### Отказоустойчивость
- Kubernetes автоматически перезапускает поды при сбоях и масштабирует их под нагрузкой.  
- NGINX выполняет health-check и исключает недоступные сервисы из пула.  
- Балансировщики разворачиваются минимум в 3 экземплярах (по зонам доступности), чтобы исключить single point of failure.  

### Резервирование
Для гарантии производительности число балансировщиков рассчитывается по формуле:  
$$
N_\text{балансировщиков} = \frac{\text{BW}_\text{пик} \times 1.3}{\text{BW}_\text{балансировщика}}
$$  

где коэффициент **1.3** учитывает резервы и пиковые нагрузки.  

### Итог
NGINX выбран как оптимальное L7-решение: он закрывает требования по производительности, поддерживает разные стратегии балансировки для различных типов трафика и легко интегрируется в Kubernetes для авто-масштабирования и отказоустойчивости.


## Источники
[^1]: [Почему Google?](https://mapsplatform.google.com/why-google/)  
[^2]: [Анализ веб-трафика Google Maps](https://pro.similarweb.com/#/digitalsuite/websiteanalysis/audience-geography/*/999/3m?key=maps.google.com&webSource=Total)  
[^3]: [Статистика и тренды Google Maps](https://www.loopexdigital.com/blog/google-maps-statistics)  
[^4]: [Как часто россияне используют геосервисы](https://iom.anketolog.ru/2020/02/12/geoservisy)  
[^5]: [Размер тайлов и кэша OSM](https://switch2osm.org/serving-tiles/plan/)  
[^6]: [Google Maps Statistics 2024](https://www.onthemap.com/blog/google-maps-statistics/)  
[^7]: [API](https://developers.google.com/maps/documentation/places/web-service/data-fields)
[^10]: [Hypestat – аудитория и география трафика](https://hypestat.com/info/maps.google.com) 
